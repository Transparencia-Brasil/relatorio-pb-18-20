---
title: "DadosJus: Libertando dados do Judiciário Brasileiro"

output:
  prettydoc::html_pretty:
    theme: cayman
    css: '../stylesheets/prettydoc-cayman.css'
    highlight: github
    df_print: paged
---

```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
library(here)
library(tidyverse)

options(scipen=999)

dados = read_csv(here("dados/data.csv"))

dados_filtrados <- dados %>% 
          filter(income_total >= 0 & wage >= 0 & perks_total >= 0 & funds_total >= 0 & discounts_total >= 0)

```
# Paraíba
## MPPB - Agosto de 2020
### Verificando colunas
#### Agency ID
Todas as linhas possuem um valor para a coluna **aid**
```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
total <- dados_filtrados %>%
  count(aid) %>%
  pull(n)

aid <- dados_filtrados %>%
  filter(aid == "mppb") %>%
  count() %>%
  pull(n)

assertthat::are_equal(total, aid)
```
#### Month
O valor de **month** é maior que 0 e menor que 13 em todas as linhas (o json diz que o mínimo deve ser 0, e o máximo 12, possível erro)
```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
count_month <- dados_filtrados %>%
  filter(month > 0 && month < 13) %>%
  count() %>%
  pull(n)

assertthat::are_equal(total, count_month)
```
#### Year
O valor de **year** é igual a 2020 em todas as linhas (o json diz que o mínimo deve ser 0, possível erro(?))
```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
count_year <- dados_filtrados %>%
  filter(year == 2020) %>%
  count() %>%
  pull(n)

assertthat::are_equal(total, count_year)
```
#### Name
Todas as linhas possuem um valor para a coluna **name** 
```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
check_names <- dados_filtrados %>%
  filter(!is.null(name)) %>%
  count() %>%
  pull(n)

assertthat::are_equal(total, check_names)
```
#### Role
Todas as linhas possuem um valor para a coluna **role**
```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
check_roles <- dados_filtrados %>%
  filter(!is.null(role)) %>%
  count() %>%
  pull(n)

assertthat::are_equal(total, check_roles)
```
#### Type
As linhas da coluna **type**, segundo o json, devem ser de um dos seguintes tipos: "servidor", "membro", "pensionista" ou "indefinido".
No entanto, os tipos presentes são: "servidor", "membro", "pensionista" e "estagiario".
```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
distribuição_dos_mppb <- dados_filtrados %>% 
  filter(aid == "mppb", month == 8) %>% 
  group_by(type) %>% 
  count()
distribuição_dos_mppb %>%
  knitr::kable()
```

Todas as linhas possuem um valor para a coluna **type**
```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
check_types <- dados_filtrados %>%
  filter(!is.null(type)) %>%
  count() %>%
  pull(n)

assertthat::are_equal(total, check_types)
```
#### Income Total
Todas as linhas possuem um valor maior ou igual a 0 para a coluna **income_total**
```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
check_income_total <- dados_filtrados %>%
  filter(!is.null(income_total)) %>%
  filter(income_total >= 0) %>%
  count() %>%
  pull(n)

assertthat::are_equal(total, check_income_total)
```
#### Perks Total
Todas as linhas possuem um valor maior ou igual a 0 para a coluna **perks_total**
```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
check_perks_total <- dados_filtrados %>%
  filter(!is.null(perks_total)) %>%
  filter(perks_total >= 0) %>%
  count() %>%
  pull(n)

assertthat::are_equal(total, check_perks_total)
```
#### Sum of all funds
Todas as linhas possuem um valor maior ou igual a 0 para a coluna **funds_total**
```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
check_funds_total <- dados_filtrados %>%
  filter(!is.null(funds_total)) %>%
  filter(funds_total >= 0) %>%
  count() %>%
  pull(n)

assertthat::are_equal(total, check_funds_total)
```
#### Total discounts
Todas as linhas possuem um valor maior ou igual a 0 para a coluna **discounts_total**
```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
check_discounts_total <- dados_filtrados %>%
  filter(!is.null(discounts_total)) %>%
  filter(discounts_total >= 0) %>%
  count() %>%
  pull(n)

assertthat::are_equal(total, check_discounts_total)
```
#### Social security discounts
Todas as linhas possuem um valor maior ou igual a 0 para a coluna **discount_prev_contribution** (No json a variavel está escrita "discounts_prev_contribution", possível erro)
```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
check_discount_prev_contribution <- dados_filtrados %>%
  filter(!is.null(discount_prev_contribution)) %>%
  filter(discount_prev_contribution >= 0) %>%
  count() %>%
  pull(n)

assertthat::are_equal(total, check_discount_prev_contribution)
```

#### Demais colunas
As colunas **reg**, **workspace**, **active**, **wage**, **perks_food**, **perks_vacation**, **perks_transportation**,  **perks_pre_school**, **perks_health**, **perks_birth**, **perks_housing**,  **perks_subsistence**, **perks_compensatory_leave**, **perks_pecuniary**, **perks_vacation_pecuniary**,  **perks_furniture_transport**, **perks_premium_license_pecuniary**, **funds_personal_benefits**, **funds_eventual_benefits**,  **funds_trust_position**, **funds_daily**, **funds_gratification**, **funds_origin_pos**, **funds_others_total**, **discount_prev_contribution**,  **discounts_ceil_retention**, **discounts_income_tax** e **discounts_others_total** não possuem nenhum tipo de regra de preenchimento no package. Mais abaixo têm-se algumas análises a respeito dos benefícios e indenizações.

```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
n_funcionarios_mppb <- dados_filtrados %>% 
  filter(year == 2020 & month == 8 & aid == "mppb") %>% 
  group_by(aid) %>% 
  count() %>% 
  pull(n)
```

## Análise Descritiva

Em agosto de 2020 o MPPB apresentava um total de **`r n_funcionarios_mppb`** funcionários.

```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
dados_filtrados %>% 
  filter(year == 2020 & month == 8) %>% 
  group_by(aid) %>% 
  count() %>% 
  ggplot(aes(x=aid, y=n, fill=aid), colour =  'black') +
  geom_bar(stat="identity") + theme_minimal() + scale_fill_brewer(palette = "Set2") + xlab("Órgão") + ylab("Total de funcionários") + labs(fill = "Tribunal", title = "Total de funcionários do MPPB em Ago de 2020" ) 
```

```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
mediana_salarial_2020_mppb <- dados_filtrados %>% 
  filter(year == 2020, aid == "mppb") %>% 
  pull(income_total) %>% 
  median() %>% 
  round(2)

max_salarial_2020_mppb <- dados_filtrados %>% 
  filter(year == 2020, aid == "mppb") %>% 
  pull(income_total) %>% 
  max()  %>% 
  round(2)

min_salarial_2020_mppb <- dados_filtrados %>% 
  filter(year == 2020, aid == "mppb") %>% 
  pull(income_total) %>% 
  min()  %>% 
  round(2)
```

No mês de agosto de 2020 a remuneração mediana foi de R\$ **`r mediana_salarial_2020_mppb`**, enquanto a máxima foi de R\$ **`r max_salarial_2020_mppb`** e a mínima de R\$ **`r min_salarial_2020_mppb`**.
A remuneração mediana no ano de 2019 foi de R\$ **9129.19**, enquanto a máxima foi de R\$ **101796.58** e a mínima de R\$ **0**.


### Distribuição dos tipos de funcionários no MPPB

```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
distribuição_dos_mppb <- dados_filtrados %>% 
  filter(aid == "mppb" , month == 8) %>% 
  group_by(type) %>% 
  count()

num_estagiarios_mppb <- distribuição_dos_mppb %>%
  filter(type == "estagiario") %>%
  pull(n)

num_membros_mppb <- distribuição_dos_mppb %>%
  filter(type == "membro") %>%
  pull(n)

num_pensionistas_mppb <- distribuição_dos_mppb %>%
  filter(type == "pensionista") %>%
  pull(n)

num_servidores_mppb <- distribuição_dos_mppb %>%
  filter(type == "servidor") %>%
  pull(n)
```

No mês de agosto de 2020 o MPPB tinha **`r num_servidores_mppb`** servidores, **`r num_pensionistas_mppb`** pensionistas, **`r num_membros_mppb`** membros e **`r num_estagiarios_mppb`** estagiários.

```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
# load library
library(ggplot2)

# Create test data.
data2 <- data.frame(
  category=c("Estagiário", "Membro", "Pensionista", "Servidor"),
  count=c(10, 280, 81, 901)
)
 
# Compute percentages
data2$fraction <- (data2$count / sum(data2$count)) * 100

# Compute the cumulative percentages (top of each rectangle)
data2$ymax <- cumsum(data2$fraction)

# Compute the bottom of each rectangle
data2$ymin <- c(0, head(data2$ymax, n=-1))

# Compute label position
data2$labelPosition <- (data2$ymax + data2$ymin) / 2

# Compute a good label
data2$label <- paste0(data2$category, "\n", round(data2$fraction, digits = 0), "%")

# Make the plot
ggplot(data2, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=category)) +
  geom_rect() +
  geom_text(x=3.5, aes(y=labelPosition, label=label, color=category), color = "white", size=2.7) + # x here controls label position (inner / outer)
  scale_fill_brewer(palette = "Set2") + theme_minimal() +
  scale_color_brewer(palette = "Set2") +
  coord_polar(theta="y") +
  xlim(c(0.6, 4)) +
  theme_void() + 
  labs(fill = "Tipo de funcionário") +
  theme(legend.position = "none")
```

### Distribuição dos tipos dos gastos em agosto de 2020

```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
bar_chart_mppb_2020 <- dados_filtrados %>%
  filter( year == 2020 & aid == "mppb") %>% 
  mutate(`Salários` = wage, `Indenizações` = perks_total, `Benefícios` = funds_total) %>%
  gather(key="type", value = "value", `Salários`, `Indenizações`, `Benefícios`) %>%
  select(name, role, value, type, month) %>%
  group_by(month, type) %>%
  summarise(sum = sum(value))

bar_chart_mppb_2020 %>%
    ggplot(aes(fill=type, y=sum, x=as.factor(month))) +
    geom_bar(position="stack", stat="identity") +
    scale_fill_brewer(palette = "Set2") + theme_minimal() +
    labs(y = "Valor total", x = "Mês", fill = "Classificação", title = "Distribuições das remunerações do MPPB em agosto de 2020") +
    scale_y_continuous(labels = scales::comma)
```

### Distribuição das remunerações dos funcionários de acordo com seu tipo 

```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
#Distribuição dos salários
dados_filtrados %>%
  filter(year == 2020 & month == 8  & aid == "mppb") %>%
  ggplot(aes(x=type, y=income_total, color=type)) +
  theme_minimal() +  
  scale_color_brewer(palette = "Set2") +
  ggbeeswarm::geom_quasirandom(shape=16, alpha= 0.5,position=position_jitter(0.2)) + labs(x="Tipos", color= "Tipo  de funcionário", y = "Remuneração",       title = "Distribuição das remunerações do MPPB em agosto de 2020") 
```

### Distribuição das remunerações em agosto de 2020

```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
remuneracao_media_mppb_2020 <- dados_filtrados  %>% 
  filter(aid == "mppb" & year == 2020) %>% 
  pull(income_total) %>% 
  mean() %>%
  round(2)
```

A remuneração média foi de R\$ **`r remuneracao_media_mppb_2020`**

```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
dados_filtrados %>% 
  filter(aid == "mppb", year == 2020) %>% 
  ggplot(aes(x = income_total, y = month, color = "mppb")) +  
  theme_minimal() + 
  scale_color_brewer(palette = "Set2") +
  geom_point(shape = 124, size = 6, alpha=0.3) + scale_y_continuous(breaks=seq(1, 11, by = 1)) + scale_x_continuous(labels = scales::comma) + theme(legend.position = "none") + labs(x = "Valor da remuneração", y = "Mês", title = "Distribuição das remunerações") + 
  geom_point(aes(x = 15768), size = 4, color = "#111111", shape = 124) +
   annotate("text", label = "Remuneração média de agosto de 2020", x = 22000, y = 13, color = "#111111") 
```

### Distribuição dos tipos de auxílios e indenizações
#### Benefícios
```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
personal <- dados_filtrados %>%
  filter(!is.null(funds_personal_benefits)) %>%
  summarise(sum = sum(funds_personal_benefits)) %>%
  pull(sum)

eventual <- dados_filtrados %>%
  filter(!is.null(funds_eventual_benefits)) %>%
  summarise(sum = sum(funds_eventual_benefits)) %>%
  pull(sum)

trust <- dados_filtrados %>%
  filter(!is.null(funds_trust_position)) %>%
  summarise(sum = sum(funds_trust_position)) %>%
  pull(sum)

daily <- dados_filtrados[!is.na(dados_filtrados$funds_daily),] %>%
  summarise(sum = sum(funds_daily)) %>%
  pull(sum)

gratification <- dados_filtrados[!is.na(dados_filtrados$funds_gratification),] %>%
  summarise(sum = sum(funds_gratification)) %>%
  pull(sum)

origin_pos <- dados_filtrados[!is.na(dados_filtrados$funds_origin_pos),] %>%
  summarise(sum = sum(funds_origin_pos)) %>%
  pull(sum)

others_total <- dados_filtrados[!is.na(dados_filtrados$funds_others_total),] %>%
  summarise(sum = sum(funds_others_total)) %>%
  pull(sum)
```

Benefícios Permanentes (funds_personal_benefits), que são os benefícios adquiridos judicialmente e os outros benefícios pessoais, são a maior parcela paga, com um montante de R\$ **`r personal`**. Benefícios Eventuais (funds_eventual_benefits), como bônus de natal e férias, equivalem ao montante de R\$ **`r eventual`**. Já os benefícios recebidos por cargos de confiança exercidos pelos empregados (funds_trust_position) equivalem a R\$ **`r trust`**. 

Os outros benefícios, **funds_daily**,	**funds_gratification**,	**funds_origin_pos** e **funds_others_total**, não possuem valores associados (todos NA).

```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
bar_chart_mppb_2020 <- dados_filtrados %>%
  filter( year == 2020 & aid == "mppb") %>% 
  mutate(`Permanentes` = funds_personal_benefits, `Bônus e Férias` = funds_eventual_benefits, `Cargo de Confiança` = funds_trust_position) %>%
  gather(key="type", value = "value", `Permanentes`, `Bônus e Férias`, `Cargo de Confiança`) %>%
  select(name, role, value, type, month) %>%
  group_by(month, type) %>%
  summarise(sum = sum(value)) 

bar_chart_mppb_2020 %>%
    ggplot(aes(fill=type, y=sum, x=as.factor(month))) +
    geom_bar(position="stack", stat="identity") +
    scale_fill_brewer(palette = "Set2") + theme_minimal() +
    labs(y = "Valor total", x = "Mês", fill = "Tipo de Benefício", title = "Distribuições dos benefícios do MPPB em agosto de 2020") +
    scale_y_continuous(labels = scales::comma)
```

#### Indenizações
```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
food <- dados_filtrados[!is.na(dados_filtrados$perks_food),] %>%
  summarise(sum = sum(perks_food)) %>%
  pull(sum)

health <- dados_filtrados[!is.na(dados_filtrados$perks_health),] %>%
  summarise(sum = sum(perks_health)) %>%
  pull(sum)

compensatory_leave <- dados_filtrados[!is.na(dados_filtrados$perks_compensatory_leave),] %>%
  summarise(sum = sum(perks_compensatory_leave)) %>%
  pull(sum)

pecuniary <- dados_filtrados[!is.na(dados_filtrados$perks_pecuniary),] %>%
  summarise(sum = sum(perks_pecuniary)) %>%
  pull(sum)

vacation <- dados_filtrados[!is.na(dados_filtrados$perks_vacation),] %>%
  summarise(sum = sum(perks_vacation)) %>%
  pull(sum)

transportation <- dados_filtrados[!is.na(dados_filtrados$perks_transportation),] %>%
  summarise(sum = sum(perks_transportation)) %>%
  pull(sum)

pre_school <- dados_filtrados[!is.na(dados_filtrados$perks_pre_school),] %>%
  summarise(sum = sum(perks_pre_school)) %>%
  pull(sum)

birth <- dados_filtrados[!is.na(dados_filtrados$perks_birth),] %>%
  summarise(sum = sum(perks_birth)) %>%
  pull(sum)

housing <- dados_filtrados[!is.na(dados_filtrados$perks_housing),] %>%
  summarise(sum = sum(perks_housing)) %>%
  pull(sum)

subsistence <- dados_filtrados[!is.na(dados_filtrados$perks_subsistence),] %>%
  summarise(sum = sum(perks_subsistence)) %>%
  pull(sum)

vacation_pecuniary <- dados_filtrados[!is.na(dados_filtrados$perks_vacation_pecuniary),] %>%
  summarise(sum = sum(perks_vacation_pecuniary)) %>%
  pull(sum)

furniture_transport <- dados_filtrados[!is.na(dados_filtrados$perks_furniture_transport),] %>%
  summarise(sum = sum(perks_furniture_transport)) %>%
  pull(sum)

premium_license_pecuniary <- dados_filtrados[!is.na(dados_filtrados$perks_premium_license_pecuniary),] %>%
  summarise(sum = sum(perks_premium_license_pecuniary)) %>%
  pull(sum)
```
Os Auxílios Alimentação (perks_food) são a maior parcela das verbas indenizatórias, com um montante de R\$ **`r food`**. Auxílios Saúde (perks_health) equivalem ao montante de R\$ **`r health`**. As Compensações por direito adquirido (perks_compensatory_leave) equivalem a R\$ **`r compensatory_leave`**. Já os pagamentos por alguma vantagem e direito do servidor público (perks_pecuniary) equivalem a R\$ **`r pecuniary`**.

Os outros benefícios não possuem valores associados. **perks_birth**, **perks_housing**, **perks_subsistence** são todos 0, enquanto **perks_vacation**,	**perks_transportation**,	**perks_pre_school**, **perks_vacation_pecuniary**, **perks_furniture_transport**, **perks_premium_license_pecuniary** são todos NA.

```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
bar_chart_mppb_2020 <- dados_filtrados %>% 
  subset(!is.na(perks_health)) %>%
  subset(!is.na(perks_pecuniary)) %>%
  subset(!is.na(perks_food)) %>%
  subset(!is.na(perks_compensatory_leave)) %>%
  filter( year == 2020 & aid == "mppb") %>% 
  mutate(`Saúde` = perks_health, `Vantagem e Direito` = perks_pecuniary, `Alimentação` = perks_food, `Compensações` = perks_compensatory_leave) %>%
  gather(key="type", value = "value", `Saúde`, `Vantagem e Direito`, `Alimentação`, `Compensações`) %>%
  select(name, role, value, type, month) %>%
  group_by(month, type) %>%
  summarise(sum = sum(value)) 

bar_chart_mppb_2020 %>%
    ggplot(aes(fill=type, y=sum, x=as.factor(month))) +
    geom_bar(position="stack", stat="identity") +
    scale_fill_brewer(palette = "Set2") + theme_minimal() +
    labs(y = "Valor total", x = "Mês", fill = "Tipo de Indenização", title = "Distribuições das indenizações do MPPB em agosto de 2020") +
    scale_y_continuous(labels = scales::comma)
```

### Distribuição dos cargos em agosto de 2020

```{r echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, paged.print = FALSE}
cargos_mppb <- dados_filtrados %>% 
  filter(year == 2020 & month == 8) %>% 
  group_by(role) %>% 
  count() %>% 
  rename(Quantidade = n, Cargo = role) %>%
  arrange(desc(Quantidade)) %>%
  knitr::kable()
cargos_mppb
```

##### TODO: Analisar picos e vales nas remunerações, benefícios e indenizações

<div class="logo">![](https://avatars2.githubusercontent.com/u/17051677?s=200&v=4)</div>
